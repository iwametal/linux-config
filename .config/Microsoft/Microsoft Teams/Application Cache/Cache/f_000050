webpackJsonp([18],{2263:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(2264),i(2268),i(2270),i(2272),i(2274)},2264:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2265),r=i(2266),n=i(2267),o=function(){function e(e,t,i,s,r,n,o,a,l,c,d,h,p,u,v,f,m){var g=this;if(this.constants=i,this.layoutService=s,this.utilityService=n,this.loggingService=o,this.messageService=a,this.filesMessagePaneHelper=l,this.authenticationService=c,this.filesEntityService=d,this.storageService=p,this.filesUtilityService=u,this.channelService=v,this.settingsService=f,this.showStartConversationButton=!1,this.panelRegions=teamspace.PanelRegion,this.moreOptionsText=e.instant(r.strings.files_moreOptions),this.startConversationClicked=!1,this.theme=f.getActiveTheme(),m.$on(t,i.events.layout.themeChanged,function(){g.theme=f.getActiveTheme()}),this.provider){if(this.provider.iconsService){var w=this.provider.iconsService.getIcon(this.fileType);w&&(this.fileIconPath=w.largeIconPath||w.defaultIconPath,this.isSvgIcon=w.isSvg,this.iconAltTextKey=w.altTextResourceKey)}h.getEntryBreadcrumbInfo(this.provider).then(function(e){g.thumbnailImgSrc=e.thumbnailImgSrc})}this.fileIconPath||(this.fileIconPath=this.getTypeSvgSrc(),this.isSvgIcon=!0),this.initConversation(),t.$on("$destroy",function(){l&&l.destroyContextMessagePane()}),this.trackData={fileId:this.fileId,fileType:this.fileType,error:this.error,errorReasonForTelemetry:this.errorReasonForTelemetry}}return e.$inject=["$translate","$scope","constants","layoutService","resources","utilityService","loggingService","messageService","filesMessagePaneHelper","authenticationService","filesEntityService","filesNavigationEntryService","storageService","filesUtilityService","channelService","settingsService","eventingService"],e.prototype.$onChanges=function(e){if(this.hasPrimaryOptions=this.primaryOptions&&this.primaryOptions.options&&this.primaryOptions.options.length&&this.primaryOptions.options.some(function(e){return!e.shouldBeHidden()}),this.settingsService.valueAsBoolean(this.constants.settings.names.enableTeamArchive)&&this.conversationInfo&&this.conversationInfo.threadId){var t=this.channelService.getParentTeamAndChannelByChannelId(this.conversationInfo.threadId);this.isTeamArchived=t&&t.team&&t.team.isArchived}this.isEditButtonAvailable=!!this.hasPrimaryOptions||this.filesUtilityService.isVisioDesktopAppOnlyEditEnabled(this.fileType)||this.moveEditInBrowserFromMoreOptions,this.hasMoreOptions=this.moreOptions&&this.moreOptions.length&&this.moreOptions.some(function(e){return!e.shouldBeHidden()}),e.error&&e.error.previousValue!==e.error.currentValue&&void 0!==e.error.currentValue&&this.initConversation(),e.displayTitleBar&&!1===e.displayTitleBar.previousValue&&!0===e.displayTitleBar.currentValue&&this.initConversation()},e.prototype.initConversation=function(){var e=this;if(this.filesMessagePaneHelper&&this._conversationInfo&&this._conversationInfo.threadId&&this.viewerType&&void 0!=this.displayTitleBar){var t=this.displayTitleBar||void 0!==this.error,i=/p2p/i.test(this._conversationInfo.serviceName);this.filesMessagePaneHelper.initializeContextMessagePane(this._conversationInfo.objectId,this._conversationInfo.threadId,this.viewerType,i,void 0,t).then(function(t){return e.updateEnablePostToChannel(t,i)})}},e.prototype.updateEnablePostToChannel=function(e,t){this.showStartConversationButton=e&&!t?!!this.channelService.canPostToChannel(this.conversationInfo.threadId)&&e:e},Object.defineProperty(e.prototype,"conversationInfo",{get:function(){return this._conversationInfo},set:function(e){this._conversationInfo||(this._conversationInfo=e,this.initConversation())},enumerable:!0,configurable:!0}),e.prototype.getTypeSvgSrc=function(){void 0===this.fileType&&(this.loggingService.warn("[getTypeSvgSrc] FileType is undefined, setting to empty string to get default svg"),this.fileType="");var e=this.utilityService.getIconClass({type:this.fileType}),t=this.constants.css.fileIcons;return[t.excel,t.onenote,t.pdf,t.powerpoint,t.visio,t.word].includes(e)?"svg/"+this.utilityService.getSVGBase(this.fileType,"icons-{type}-file-32_1.5x")+".html":"svg/"+this.utilityService.getSVGBase(this.fileType,"icons-{type}")+".html"},e.prototype.startConversation=function(){var e=this;if(!this.startConversationClicked){this.startConversationClicked=!0;var t=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.filesMessagePaneHelper.getReplyChainIdFromFileId(this._conversationInfo.objectId,this._conversationInfo.threadId).then(function(i){i?(e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0),e.filesMessagePaneHelper.showRightRail(e._conversationInfo.threadId,i,teamspace.services.ReplyChainIdType.ParentMessageId,/p2p/i.test(e._conversationInfo.serviceName)),e.showStartConversationButton=!1,t.stop()):(e.createFileAttachment?e.createFileAttachment():e.filesEntityService.getFileDetail(e.fileType,e.conversationInfo.objectUrl).then(function(e){return e.value}).then(function(t){return e.getAttachment(t)})).then(function(t){var i=e.getMessageParams(t,e.conversationInfo.threadId);return e.messageService.createMessage(i)}).then(function(t){return e.authenticationService.getUserInformation().then(function(e){return{upn:((e||{}).profile||{}).upn,messageId:t.messageId}})}).then(function(t){return t.upn?e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0):e.loggingService.warn("Failed to resolve user upn on start conversation"),t.messageId?e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0):e.loggingService.warn("Failed to resolve messageId on start conversation"),t.messageId}).then(function(t){return e.filesMessagePaneHelper.initializeContextMessagePane(e.conversationInfo.objectId,e.conversationInfo.threadId,e.viewerType,!1,t)}).then(function(){return e.showStartConversationButton=!1}).then(function(){return t.stop()}).catch(function(i){var s="Failed to start conversation";e.startConversationClicked=!1,e.loggingService.error(s),t.fail({error:s})})})}},e.prototype.rightRailShowExistingComponent=function(){var e=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.layoutService.rightRailShowExistingComponent(),e.stop()},e.prototype.getAttachment=function(e){return{objectId:e.objectId,objectUrl:e.objectUrl,siteUrl:e.siteUrl,serverRelativeUrl:e.serverRelativeUrl,title:e.title,type:e.type}},e.prototype.getMessageParams=function(e,t){return{conversationId:t,replyChainId:"",messageSubject:"",messageBody:"",messagePreview:"",fileAttachments:[e],extensions:"",mentions:"",embeddedLinks:[],isHtml:!0,importance:null,clientId:SkypeX.Services.Utilities.newClientMessageId(),draftObjectId:""}},e}();angular.module("teamspace.fileDocumentTitleBar",["teamspace.layoutService","teamspace.utilityService","teamspace.loggingService","teamspace.messageService","teamspace.settingsService","teamspace.filesEntityService","teamspace.authenticationService","teamspace.filesMessagePaneHelper"]).component("fileDocumentTitleBar",{bindings:{isEditMode:"<?",displayTitleBar:"<?",editAction:"<?",fileName:"<",fileType:"<",fileId:"<",viewerType:"<",hideClose:"<?",onClose:"&?",isEnabled:"=",inlineActions:"<?",primaryOptions:"<?",moreOptions:"<?",conversationInfo:"<?",createFileAttachment:"&?",provider:"<?",error:"<?",errorReasonForTelemetry:"<?",moveEditInBrowserFromMoreOptions:"<?"},template:s,controller:o}).run(["$templateCache",function(e){e.put("components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html",r),e.put("components/files/document-viewer/file-document-title-bar/file-document-title-bar-more-options.html",n)}])},2265:function(e,t){e.exports='<div class="app-title-bar" analytics-panel="{{::$ctrl.panelRegions.main}}" analytics-panel-view="{ panel: {type: {{$root.trackConstants.panelType.documentStage}} }}" track-data="{{::$ctrl.trackData}}">\n  <svg-include class="title-component title-visible svg-icon" ng-if="$ctrl.isSvgIcon" src="::$ctrl.fileIconPath"></svg-include>\n  <div class="title-component title-visible img-icon" ng-if="!$ctrl.isSvgIcon">\n    <img ng-src="{{::$ctrl.fileIconPath}}" alt="{{::$ctrl.iconAltTextKey|translate}}" title="{{::$ctrl.iconAltTextKey|translate}}"/>\n  </div>\n  <h1 class="title-component title-visible" data-tid="document-stage-title-bar">\n    <span class="document-title" tabindex="0" role="heading">{{::$ctrl.fileName}}</span>\n  </h1>\n  \x3c!--\n    TODO: Requirement 437506\n      <span class="save-status" id="file-save-status"></span>\n  --\x3e\n</div>\n<div class="right-side-buttons pull-right">\n  <div ng-if="::$ctrl.thumbnailImgSrc" class="provider-icon">\n    <span class="app-svg img-container">\n      <img ng-src="{{::$ctrl.thumbnailImgSrc}}"/>\n    </span>\n  </div>\n  <div ng-if="$ctrl.inlineActions && $ctrl.inlineActions.length">\n    <button class="ts-sym inline-action" type="button" ng-repeat="menuItem in $ctrl.inlineActions track by $index" ng-if="!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" ng-click="menuItem.click()" ng-disabled="!$ctrl.isEnabled" aria-label="{{menuItem.title || menuItem.displayName || undefined}}" ng-attr-title="{{menuItem.title || undefined}}">\n      <svg-include src="menuItem.svgPath"></svg-include>\n      <span>{{menuItem.displayName}}</span>\n    </button>\n  </div>\n  <div class="btn-edit btn-group" ng-if="$ctrl.isEditButtonAvailable && !$ctrl.isEditMode && $ctrl.editAction">\n      <button class="btn ts-btn ts-btn-fluent ts-btn-fluent-titlebar" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" aria-label="{{::$ctrl.primaryOptions.primaryButtonAria}}" type="button" ng-click="$ctrl.editAction()" ng-disabled="!$ctrl.isEnabled || $ctrl.isTeamArchived" data-tid="title-bar-primary-edit-button">\n        <span class="ts-btn-edit-text">{{::$ctrl.primaryOptions.primaryButtonText}}</span>\n      </button>\n      <div ng-if="::$ctrl.hasPrimaryOptions" class="dropdown-separator"></div>\n      <button ng-if="::$ctrl.hasPrimaryOptions" aria-label="{{::$ctrl.primaryOptions.dropdownButtonText}}" class="btn ts-btn ts-btn-fluent tn-btn-titlebar inset-border dropdown-toggle-split" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" ng-disabled="!$ctrl.isEnabled || $ctrl.isTeamArchived" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html" data-tid="title-bar-dropdown-edit-button">\n        <svg-include src="\'svg/icons-triangle-down-small.html\'"></svg-include>\n      </button>\n  </div>\n    <button class="ts-btn ts-btn-fluent ts-btn-fluent-titlebar" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" ng-if="::$ctrl.hasPrimaryOptions && !$ctrl.editAction" type="button" ng-disabled="!$ctrl.isEnabled" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html" data-tid="title-bar-edit-button">\n      <span class="ts-btn-edit-text">{{::$ctrl.primaryOptions.primaryButtonText}}</span>\n      <ng-include src="\'svg/icons-triangle-down-small.html\'"></ng-include>\n    </button>\n    <button ng-show="$ctrl.showStartConversationButton" class="ts-btn ts-btn-fluent ts-btn-fluent-secondary ts-btn-fluent-titlebar" type="button" ng-click="$ctrl.startConversation()" translate-once="{{::$root.resources.strings.files_startConversation }}" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.fileStartConversation}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageStartConversationButton}}" track-type="{{::$root.trackConstants.trackType.submit}}" track-summary="Starts a conversation around the file and opens the chat pane" data-tid="start-conversation" ng-disabled="!$ctrl.isEnabled">\n    </button>\n    <button class="ts-btn ts-btn-fluent ts-btn-fluent-secondary btn-close ts-btn-fluent-titlebar" ng-if="$ctrl.onClose && !$ctrl.hideClose" type="button" ng-click="$ctrl.onClose()" track-outcome="{{::$root.trackConstants.trackOutcome.nav}}" track-scenario="{{::$root.trackConstants.trackScenario.closeDocumentStage}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageCloseButton}}" track-type="{{::$root.trackConstants.trackType.other}}" track-summary="Close the document stage" aria-label="{{::$root.resources.strings.files_closeDocumentStageAria | translate }}" translate-once="{{::$root.resources.strings.files_closeFullscreenButton }}" data-tid="fullscreen-close-button">\n    </button>\n</div>\n<span ng-if="!$ctrl.hasMoreOptions" class="right-padding"></span>\n<div ng-if="$ctrl.hasMoreOptions" class="inline-button pull-right">\n  <button class="ts-sym app-icons-fill-hover" title="{{::$ctrl.moreOptionsText}}" aria-label="{{::$ctrl.moreOptionsText}}" type="button" ng-disabled="!$ctrl.isEnabled" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-more-options.html" data-tid="title-bar-more-button" aria-haspopup="true">\n    <ng-include src="\'svg/icons-more.html\'"></ng-include>\n  </button>\n</div>\n<div class="inline-button pull-right collapsable" ng-class="{\'expand\': $ctrl.layoutService.rightRailVisible || !$ctrl.layoutService.rightRailContext}">\n  <button ng-disabled="!$ctrl.isEnabled" type="button" ng-if="!$ctrl.layoutService.rightRailVisible && $ctrl.layoutService.rightRailContext" class="ts-sym app-icons-fill-hover pull-right" ng-click="$ctrl.rightRailShowExistingComponent()" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.fileStartConversation}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageStartConversationButton}}" track-type="{{::$root.trackConstants.trackType.submit}}" track-summary="Opens the conversation around the file" data-tid="document-chat-expand" title="{{::$root.resources.strings.calling_toggleChat_on|translate}}" aria-label="{{::$root.resources.strings.calling_toggleChat_on|translate}}">\n    <ng-include src="\'svg/icons-chat.html\'"></ng-include>\n  </button>\n</div>\n'},2266:function(e,t){e.exports='<div class="context-dropdown dropdown-menu dropdown app-default-menu files-popover">\n  <ul class="context-menu-dropdown file-action-menu" acc-role="menu">\n    <li ng-repeat="menuItem in $ctrl.primaryOptions.options track by $index" ng-class="::menuItem.class" ng-if="!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" class="ts-menu-item" acc-role="menu-item focus-default" aria-label="{{ ::menuItem.displayName }}">\n      <button class="ts-sym ts-svg" acc-role="focus-default" ng-click="menuItem.click()" data-tid="{{ menuItem.id }}" type="button" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{menuItem.id == \'office-open-in-desktop-app\' ? $root.trackConstants.trackScenario.editFileInApp : $root.trackConstants.trackScenario.editFileOnline}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.fileDocumentTitleBar}}" track-type="{{::$root.trackConstants.trackType.menuItem}}" track-data="{fileAction: \'{{::menuItem.id}}\', fileControl: \'file edit menu\', fileId: \'{{::$ctrl.fileId}}\'}" track-summary="Edit a file in app OR edit a file in Office online">\n        <ng-include src="menuItem.svgPath"></ng-include>\n        <span aria-hidden="true">{{menuItem.displayName}}</span>\n      </button>\n    </li>\n  </ul>\n</div>'},2267:function(e,t){e.exports='<div class="context-dropdown dropdown-menu dropdown app-default-menu files-popover">\n  <ul class="context-menu-dropdown file-action-menu" acc-role="menu">\n    <li ng-repeat="menuItem in $ctrl.moreOptions track by $index" ng-if="::!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" class="ts-menu-item" acc-role="menu-item focus-default" aria-label="{{ ::menuItem.displayName }}">\n      <button class="ts-sym ts-svg" type="button" ng-click="menuItem.click()" data-tid="{{ menuItem.id }}" track-outcome="{{::$root.trackConstants.trackOutcome.select}}" track-scenario="{{::$root.trackConstants.trackScenario.selectFileAction}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.fileActionButton}}" track-type="{{::$root.trackConstants.trackType.menuItem}}" track-data="{fileAction: \'{{::menuItem.id}}\', fileControl: \'file action menu\', fileId: \'{{::$ctrl.fileId}}\'}" track-summary="Choose a file action to perform - document stage">\n        <ng-include src="menuItem.svgPath"></ng-include>\n        <span aria-hidden="true">{{menuItem.displayName}}</span>\n      </button>\n    </li>\n  </ul>\n</div>'},2268:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var r,n=i(2269),o=i(48);!function(e){e.SameDocument="0",e.NewDocument="1"}(r=t.RebootMode||(t.RebootMode={}));var a=function(){function e(e,t,i,s,r,n,a,l,c,d,h,p,u,v,f,m,g,w,y,S,b,I,C,E,U,T,P,$,A,k,F){var D=this;this.$scope=e,this.$q=t,this.resources=s,this.$timeout=n,this.$state=a,this.$window=l,this.$sce=c,this.settingsService=d,this.layoutService=h,this.constants=p,this.loggingService=u,this.utilityService=v,this.filesUtilityService=f,this.authenticationService=m,this.routeUtilityService=g,this.filesDocStageHelperService=w,this.filesMessagePaneHelper=y,this.storageService=S,this.messageService=b,this.routeChangeService=I,this.navigationService=E,this.localizationService=U,this.filesProviderFactory=T,this.createFileFactory=$,this.personalFilesDetailsService=A,this.filesNotificationService=k,this.filesOpenActionSettingService=F,this.webviewElement=null,this.iframeElement=null,this.isCloseButtonClick=!1,this.canPostConversation=!0,this.isConversationPanelOpen=!1,this.childMessageListner=function(e){if(D.iframeElement=D.iframeElement?D.iframeElement:document.getElementById("file-unified-app-viewer-frame"),D.iframeElement&&e.source===D.iframeElement.contentWindow)return D.commonMessageListner({data:e.data})},this.regionalOSSettingPromise=this.getRegionalOSSetting(),this.messageType=p.messages.types.newConversation,this.canPostConversation=C.canPostToCurrentChannel(),this.filesConversationEmptChatPaneHeader=i.instant(s.strings.files_conversation_empty_chat_pane_header),this.filesConversationEmptChatPaneBody=i.instant(s.strings.files_conversation_empty_chat_pane_body),this.logger=u.newLogger("FileViewer"),this.useWebview=d.valueAsBoolean(p.settings.names.isDesktopApp)&&!!l.electronSafeIpc&&l.desktopSettings.enableTabWebviews;var O,x,N=l.electronSafeIpc,M=this.layout.bind(this),R=!1;this.entityContext={id:this.fileId,objectUrl:this.objectUrl,serviceName:this.serviceName,title:this.fileName},this.jsApiHostSessionId=u.sessionId+"-"+this.scenario.id,this.routeDocumentViewerParams=g.getRootRouteParams(),N&&this.useWebview?(N.send(p.events.desktopApp.allowWebViewCreate,{enablePreload:!0}),N.once(p.events.desktopApp.webViewCreationEnabled,function(){D.webviewElement=window.document.getElementById("file-unified-app-viewer-webview"),D.webviewElement.setAttribute("webpreferences","nativeWindowOpen=yes"),D.webviewElement.setAttribute("allowpopups",""),D.eventListener=new o.EventListener(D.webviewElement);D.eventListener.addListener("ipc-message",function(e){return D.webviewProcessMessage(e)});D.eventListener.addListener("crashed",function(e){return u.event(p.telemetry.webview.crashed,{errorEvent:JSON.stringify(e)})});D.eventListener.addListener("gpu-crashed",function(e){return u.event(p.telemetry.webview.gpuCrashed,{errorEvent:JSON.stringify(e)})});D.eventListener.addListener("plugin-crashed",function(e){return u.event(p.telemetry.webview.pluginCrashed,{errorEvent:JSON.stringify(e)})});D.eventListener.addListener("did-fail-load",function(e){u.event(p.telemetry.webview.loadFailed,{errorEvent:JSON.stringify({errorCode:e?e.errorCode:null,errorDescription:e?e.errorDescription:null})}),D.logger.error("loading failed - did-fail-load fired")}),D.eventListener.addListener("dom-ready",M),D.eventListener.addListener("load-commit",function(e){e&&e.isMainFrame&&(x=O?(Date.now()-O).toString():""),R=e&&e.url&&e.url.startsWith(D.filesExpBaseUrl)}),D.eventListener.addListener("did-frame-finish-load",function(e){if(R){var t={filesExpFrameLoadTime:O?(Date.now()-O).toString():"",webviewFirstLoadCommitTime:x};D.logger.info("did-frame-finish-load scenario markers for files exp frame {0}",t),D.scenario.mark("files-experience-frame-load-time",t),R=!1}}),l.addEventListener("resize",M),D.init(),O=Date.now()})):(this.init(),this.registerForBaseEvents()),I.registerRouteChangeHandler(p.states.appDocumentViewer,this.routeChangeHandler.bind(this)),e.$on("$destroy",function(){l.removeEventListener("resize",M),l.removeEventListener("message",D.childMessageListner),D.eventListener&&D.eventListener.destroy(),f.isIntegratedUXEnabled(D.fileType)&&w.changeFileNameInTeamsChromeHeader(!1),y&&y.destroyContextMessagePane(),I.unregisterRouteChangeHandler(p.states.appDocumentViewer)}),this.isWACAppCreateNewDocumentScenarioEnabled()&&(this.listenerRegistration=P.register(this,e))}return e.$inject=["$scope","$q","$translate","resources","$rootScope","$timeout","$state","$window","$sce","settingsService","layoutService","constants","loggingService","utilityService","filesUtilityService","authenticationService","routeUtilityService","filesDocStageHelperService","filesMessagePaneHelper","storageService","messageService","routeChangeService","channelService","navigationService","localizationService","filesProviderFactory","sharePointStore","createFileFactory","personalFilesDetailsService","filesNotificationService","filesOpenActionSettingService"],e.prototype.routeChangeHandler=function(e,t,i,s){var r=this;if(s.name===this.constants.states.appDocumentViewer&&!e.defaultPrevented){var n=!0===this.isCloseButtonClick?this.settingsService.valueFor(this.constants.settings.names.closeDocStagePromiseTimeout):this.settingsService.valueFor(this.constants.settings.names.navigationDocStagePromiseTimeout);this.logger.info("unloading timeout {0}",n);var o=function(){r.logger.info("navigating away from doc-stage on timeout "+n),r.routeChangeService.unregisterRouteChangeHandler(r.constants.states.appDocumentViewer),r.$state.go(t,i)};if(0==n)return void o();this.toStateForUnloading=t,this.toStateParamsForUnloading=i,this.unlockFilePromise=this.filesDocStageHelperService.unlockFile(n).finally(function(){return o()}),e.preventDefault()}},e.prototype.registerForBaseEvents=function(){this.$window.addEventListener("message",this.childMessageListner)},e.prototype.commonMessageListner=function(e){switch(e.data.channel){case"multi-window-manager-channel":return this.handlePostMessagesEvents(e.data.payload)}},e.prototype.handlePostMessagesEvents=function(e){var t=this;switch(this.logger.info("Post message received for event {0}",e.eventId),e.eventId){case teamspace.services.ChildWindowEventRequest.WindowReady:this.logger.info("Child frame has reported ready state");break;case teamspace.services.ChildWindowEventRequest.WindowInitialized:this.logger.info("Child frame has reported it is fully initialized");break;case teamspace.services.ChildWindowEventRequest.NewWindow:this.logger.info("Child frame requested to open new window directly (blocked)");break;case teamspace.services.ChildWindowEventRequest.AadGetToken:var i=e.eventId;if(e.correlationId&&e.payload){r=e.payload.resource;return this.filesUtilityService.updateTokenWarmingRule(r),this.logger.info("Child frame requested AAD token: resource={0}, correlationId={1}",r,e.correlationId),this.authenticationService.getAuthTokens([r]).then(function(s){var r={eventId:i,correlationId:e.correlationId,payload:{token:s}};t.filesDocStageHelperService.sendPostMessage(r,t.iframeElement,t.webviewElement)}).catch(function(i){t.logger.error("ERROR: failed to get auth token: correlationId={0}, error={1}",e.correlationId,i)})}this.logger.error("Expected payload or correlationId for {0} but got none",i);break;case teamspace.services.ChildWindowEventRequest.AadGetCurrentUser:if(e.correlationId)return this.logger.info("Child frame requested current logged in user correlationId={0}",e.correlationId),this.authenticationService.getUserInformation().then(function(i){var s={eventId:e.eventId,correlationId:e.correlationId,payload:{authUser:i}};t.filesDocStageHelperService.sendPostMessage(s,t.iframeElement,t.webviewElement)}).catch(function(i){t.logger.error("ERROR: failed to get current logged in user correlationId={0}, error={1}",e.correlationId,i)});this.logger.error("ERROR: AadGetCurrentUser request was made but no correlationId was given");break;case teamspace.services.ChildWindowEventRequest.AadClearCache:if(e.payload){var r=e.payload.resource;this.logger.info("Child frame requested clear adal cache:  resource={0}, correlationId={1}",r,e.correlationId),r&&this.authenticationService.clearAdalCache(r)}else this.logger.error("Expected data for event {0} but got none",e.event);break;case teamspace.services.ChildWindowEventRequest.HideFileViewerLoader:this.hideSpinner();break;case teamspace.services.ChildWindowEventRequest.StopDocStageScenario:e.payload&&this.handleScenario(e.payload);break;case teamspace.services.ChildWindowEventRequest.GetDriveItemResponse:w=e.payload&&e.payload.sendTime&&Date.now()-e.payload.sendTime;return this.scenario.mark("exp-request-drive-item",{ipcTimeOverhead:w}),this.$q.all([this.redeemPromise,this.regionalOSSettingPromise]).then(function(i){var r=i[0],n=i[1],o=r.sensitivityLabel&&r.sensitivityLabel.protectionEnabled;t.scenario.mark("redeem-post-success");var a=s({},r,{driveItemCallStartTime:t.driveItemCallStartTime,driveItemCallEndTime:Date.now(),localeFromOS:n,fileActions:t.filesUtilityService.isIntegratedUXEnabled(t.fileType)?t.filesDocStageHelperService.getFileActions(r,t.hideClose,t.fileType):null,flights:t.getWACFileScenarioFlights(),sessionOrigin:t.getWacSessionOrigin(),file:s({},r.file,{irmEnabled:o})});t.isWACAppDocRebootScenarioEnabled()&&(a.rebootOverrideData=t.routeDocumentViewerParams.rebootOverrideData);var l={eventId:e.eventId,correlationId:e.correlationId,payload:a};t.logger.info("sending redeem response to Files experience"),t.filesDocStageHelperService.sendPostMessage(l,t.iframeElement,t.webviewElement);var c=t.utilityService.getIconClass({type:t.fileType})===t.constants.css.fileIcons.word,d=r.currentUserRole&&r.currentUserRole.readOnly;t.fileName!=r.name&&(t.fileName=r.name),(d||o)&&c?t.moveEditInBrowserFromMoreOptions||(t.displayTitleBar=!0,t.isEditMode=!0):t.filesUtilityService.isIntegratedUXEnabled(t.fileType)&&!1===t.displayTitleBar&&t.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,t.fileName)});case teamspace.services.ChildWindowEventRequest.AddScenarioMarker:e.payload&&this.addScenarioMarker(e.payload);break;case teamspace.services.ChildWindowEventRequest.FilesExperienceSendData:switch(this.logger.info("Post message received with messageId {0}",e.payload.MessageId),e.payload.MessageId){case"App_AccessibilityLoopComplete":var n="backward"!==e.payload.Values.Direction;this.layoutService.navigateToNextLandmark(n);break;case"Wac_ActionComplete":this.logger.info("wac action completed {0} ",e.payload);var o=e.payload.Values&&e.payload.Values.Action;if(!o)return void this.logger.info("unknown action reported from WAC");if("OpenInBrowser"===o)return void this.findAndPerformActionButtonClick("office-open-in-new-tab");"OpenInDesktop"===o&&this.filesDocStageHelperService.logAction("Open_In_Desktop",this.fileId,this.fileType);var a=e.payload.sendTime,l=e.payload.SendTime,c=l&&a?(a-l).toString():"",d=a?(Date.now()-a).toString():"",h=l?(Date.now()-l).toString():"",p=e.payload.Values&&e.payload.Values.wdUserSession,u=this.constants.scenarios.files.openOfficeFileInDesktop,v=this.loggingService.newScenario(u);v.eventData.entryPoint=this.serviceName,v.eventData.context=this.ctx||this.utilityService.getUrlRootContext(),v.eventData.type=this.fileType,v.eventData.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,v.stop({ipcOverheadToExperienceFromWac:c,ipcOverheadToMainAppFromExperience:d,ipcOverHead:h,wdUserSession:p,jsApiHostSessionId:this.jsApiHostSessionId});break;case"Action_Button_Click":var f=e.payload&&e.payload.SendTime,m={ipcOverheadToExperienceFromWac:f&&e.payload.receivedTime?(e.payload.receivedTime-f).toString():"",ipcOverheadToMainAppFromExperience:e.payload.receivedTime?(Date.now()-e.payload.receivedTime).toString():"",ipcOverHead:f&&(Date.now()-f).toString(),ipcCorrelationId:e.payload.CorrelationId,ipcwdUserSession:e.payload.wdUserSession,jsApiHostSessionId:this.jsApiHostSessionId};this.logger.info("wdUserSession {0} correlationId {1} hostSessionId {2}",e.payload.wdUserSession,e.payload.CorrelationId,this.jsApiHostSessionId);var g=this.constants.scenarios.files.actionButton+"_"+e.payload.button;this.loggingService.newScenario(g).stop(m),this.handleActionButtonsClick(e.payload.button),this.filesDocStageHelperService.logAction(e.payload.button,this.fileId,this.fileType);break;case"Unload":var w=e.payload.sendTime&&Date.now()-e.payload.sendTime;this.$timeout.cancel(this.unlockFilePromise),this.closeFileUnlockScenario(w),this.routeChangeService.unregisterRouteChangeHandler(this.constants.states.appDocumentViewer),this.$state.go(this.toStateForUnloading,this.toStateParamsForUnloading);break;case"Reboot":this.rebootFile(e.payload);break;case"Error":this.logger.error("ErrorMessage: "+e.payload.errorMessage),this.handleErrorFromNStarExperience(e.payload);break;case"App_SwitchMode":this.handleModeSwitch(e.payload);break;case"Get_ReplyChainId":var y=void 0,S=this.routeDocumentViewerParams.messageId;S?y=this.$q.resolve(S):(this.replyChainIdPromise||(this.replyChainIdPromise=this.filesMessagePaneHelper.getReplyChainIdFromFileId(this.fileId,this.threadId)),y=this.replyChainIdPromise),y.then(function(i){var s={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,correlationId:e.correlationId,payload:{replyChainId:i,threadId:t.threadId}};t.filesDocStageHelperService.sendPostMessage(s,t.iframeElement,t.webviewElement)});break;case"Open_File":this.gotoSPOFile(e.payload);break;case"App_CreateNewDocument":this.createNewFile(e.payload)}break;default:this.logger.info("Child frame has reported event {0} which doesn't exist {1}",e.eventId,e)}},e.prototype.getRegionalOSSetting=function(){var e=this,t=this.$q.defer(),i=this.settingsService.valueAsBoolean(this.constants.settings.names.enableRegionalSettingFromOS),s=this.utilityService.getIconClass({type:this.fileType})===this.constants.css.fileIcons.excel;return i&&s&&this.$window.getLocaleInfoAsync?(this.scenario.mark("get-regional-setting-call-start"),this.$window.getLocaleInfoAsync().then(function(i){e.scenario.mark("get-regional-setting-call-end"),t.resolve(i&&i.regionalFormat)}).catch(function(i){e.scenario.mark("get-regional-setting-call-failed",{reason:JSON.stringify(i)}),t.resolve(void 0)})):t.resolve(void 0),t.promise},e.prototype.isWACAppDocRebootScenarioEnabled=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppDocRebootScenario)},e.prototype.getWACFileScenarioFlights=function(){return{enableWACAppCreateNewDocumentScenario:this.isWACAppCreateNewDocumentScenarioEnabled(),enableWACAppDocRebootScenario:this.isWACAppDocRebootScenarioEnabled(),enableWordRibboninReadMode:this.isWordRibbonInReadOnlyModeEnabled(),enableWACAppModeSwitch:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppModeSwitch)}},e.prototype.isWordRibbonInReadOnlyModeEnabled=function(){return this.utilityService.getIconClass({type:this.fileType})===this.constants.css.fileIcons.word&&this.settingsService.valueAsBoolean(this.constants.settings.names.enableWordRibboninReadMode)},e.prototype.isWXPExtension=function(e){var t=this.utilityService.getIconClass({type:e});return t===this.constants.css.fileIcons.word||t===this.constants.css.fileIcons.powerpoint||t===this.constants.css.fileIcons.excel},e.prototype.onStateChanged=function(e){this.isWACAppCreateNewDocumentScenarioEnabled()&&(e.createErrorData?e.createErrorData.errorCode===this.constants.files.error.filenameCollision&&(this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileRenameConflictError),this.logger.info("File name collision")):e.viewerRoute&&e.createdEntityWacUrl&&(e.viewerRoute.documentViewerParams.wacScenario=this.constants.wacScenario.createNewDoc,this.filesUtilityService.navigateToNewFile(e)))},e.prototype.gotoSPOFile=function(e){var t=e.serviceName?e.serviceName:this.constants.files.serviceName.teams,i={documentViewerParams:{fileType:e.fileType,serviceName:t,objectUrl:e.objectUrl,threadId:e.threadId,messageId:e.messageId,baseUrl:e.baseUrl,fileId:e.fileId,viewerAction:this.constants.files.fileActions.viewer.view},viewerState:this.constants.states.appDocumentViewer};return this.navigationService.navigateToFileViewer(i)},e.prototype.handleErrorFromNStarExperience=function(e){this.hideSpinner(),this.handleScenario(s({status:!1},e)),this.displayTitleBar=!0,this.fileErrorCode=this.constants.files.error.unknown+"_unifiedapp",this.allowDownloadOnError=e.allowDownload},e.prototype.handleActionButtonsClick=function(e){switch(e){case"Conversation":this.layoutService.rightRailVisible?this.layoutService.rightRailHide():this.isConversationPanelOpen?this.isConversationPanelOpen=!1:this.setUpConversationPane();break;case"Close":this.isCloseButtonClick=!0,this.onClose();break;case"Open_In_Desktop":this.findAndPerformActionButtonClick("office-open-in-desktop-app");break;case"Open_In_Browser":this.findAndPerformActionButtonClick("office-open-in-new-tab");break;case"Download":this.findAndPerformActionButtonClick("download-office-document")}},e.prototype.findAndPerformActionButtonClick=function(e){this.moreOptions.filter(function(t){return t.id===e})[0].click()},e.prototype.initiateConversation=function(e){var t=this,i=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.redeemPromise.then(function(e){var i=e,s=i.webDavUrl,r=i.name,n=i.sharepointIds,o=n.siteUrl,a=n.listItemUniqueId;return{serverRelativeUrl:t.filesUtilityService.extractServerRelativeUrl(s),siteUrl:o,objectUrl:s,objectId:a,title:r,type:t.fileType}}).then(function(s){var r=t.createMessageWithCurrentFile(e,s);return r.scenario=i,t.messageService.createMessage(r)}).then(function(e){t.isConversationPanelOpen=!1,t.storageService.set(""+t.constants.files.strings.saveChatIsExpanded,!0),t.filesMessagePaneHelper.initializeContextMessagePane(t.fileId,t.threadId,teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,!1,e.messageId),t.replyChainIdPromise=null}).then(function(){return i.stop()}).catch(function(e){var s="Failed to start conversation";t.loggingService.error(s),i.fail({error:s})})},e.prototype.createMessageWithCurrentFile=function(e,t){var i={conversationId:this.threadId,replyChainId:"",messageSubject:e?e.subject:"",messageBody:e?e.message:"",messagePreview:e?e.preview:"",fileAttachments:e?e.attachments:[],extensions:e?e.extensions:"",mentions:e?e.mentions:"",embeddedLinks:e?e.embeddedlinks:[],isHtml:!0,importance:e?e.importance:null,clientId:SkypeX.Services.Utilities.newClientMessageId(),draftObjectId:e?e.draftObjectId:""};return i.fileAttachments.push(t),i},e.prototype.setUpConversationPane=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened),i=/p2p/i.test(this.serviceName);if(i)return this.storageService.set(""+this.constants.files.strings.saveChatIsExpanded,!0),this.filesMessagePaneHelper.showRightRail(this.threadId,void 0,teamspace.services.ReplyChainIdType.MessageId,i),void t.stop();this.replyChainIdPromise||(this.replyChainIdPromise=this.filesMessagePaneHelper.getReplyChainIdFromFileId(this.fileId,this.threadId)),this.replyChainIdPromise.then(function(s){s?(e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0),e.filesMessagePaneHelper.showRightRail(e.threadId,s,teamspace.services.ReplyChainIdType.ParentMessageId,i),t.stop()):e.isConversationPanelOpen=!0}).catch(function(){e.replyChainIdPromise=null;var i="Failed to get reply chain";e.loggingService.error(i),t.fail({error:i})})},e.prototype.closeConversationPane=function(){this.isConversationPanelOpen=!1},e.prototype.addScenarioMarker=function(e){var t=e.errorMessage,i=e.sendTime,s=e.scenarioMarker,r=e.cached,n=i&&Date.now()-i;this.logger.info("scenarioMarker {0}",s),this.scenario.mark(s,{ipcTimeOverhead:n,errorMessage:t,cached:r})},e.prototype.closeFileUnlockScenario=function(e){var t=this.routeDocumentViewerParams.serviceName?decodeURIComponent(this.routeDocumentViewerParams.serviceName):void 0,i=this.filesDocStageHelperService.getPivot(t),s=this.constants.scenarios.files.closeFile+"_"+i,r=this.loggingService.findScenario(s);r?r.stop({ipcTimeOverhead:e,openFileScenarioId:this.scenario&&this.scenario.id}):this.logger.error("file-unified-app-viewer: could not find scenario"),this.logger.info("navigating away from doc-stage on Unload post-message")},e.prototype.handleScenario=function(e){var t=e.status,i=e.sendTime,s=e.officeSessionId,r=e.officeBootstrapperVersion,n=i&&Date.now()-i;if(t){var o=e.deltaWithPerceivedBoot;this.scenario.stop({deltaWithPerceivedBoot:o,officeSessionId:s,ipcTimeOverhead:n}),this.handleFileOpenPreferenceScenarios()}else{var a=e.errorMessage;this.scenario.fail({errorMessage:a,officeSessionId:s,ipcTimeOverhead:n})}this.logger.info("officeSessionId {0} hostSessionId {1} officeBootstrapperVersion {2}",s,this.jsApiHostSessionId,r)},e.prototype.handleFileOpenPreferenceScenarios=function(){var e=this.isTabbedFile(),t=this.isNewFile(),i=this.isThirdPartyFileOpen();e||t||i||this.filesOpenActionSettingService.handleFileOpenPreferenceUpdate(teamspace.services.FileOpenPreference.Teams,this.fileType,{serviceName:this.serviceName,context:this.ctx,fileAction:this.filesUtilityService.getFileActionName(teamspace.services.FileOpenPreference.Teams)})},e.prototype.isNewFile=function(){return this.ctx===this.constants.scenarios.files.newFileCreationContext},e.prototype.isThirdPartyFileOpen=function(){return this.ctx===this.constants.SdkMessageTypes.openFilePreview},e.prototype.handleFocus=function(e){var t=e.target.dataset.focusDirection||(e.shiftKey?"backward":"forward"),i={MessageId:"Host_AccessibilityLoopComplete",SendTime:Date.now(),Values:{Direction:t}},s={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:i};(this.iframeElement||this.webviewElement).focus(),this.filesDocStageHelperService.sendPostMessage(s,this.iframeElement,this.webviewElement)},e.prototype.handleModeSwitch=function(e){var t=this;if(this.filesUtilityService.isIntegratedUXEnabled(this.fileType)){if(this.moveEditInBrowserFromMoreOptions)return void this.logger.info("ignoring App_SwitchMode post-message from wac frame when intentional RO mode is set");var i=e.Editable;if("view"===e.NewMode)this.$scope.$apply(function(){t.displayTitleBar=!0,t.isEditMode=!i}),this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!1);else if("edit"===e.NewMode){var s=this.constants.scenarios.files.editFileFullScreen+"_"+this.serviceName,r=this.loggingService.findScenario(s);r?r.stop({jsApiHostSessionId:this.jsApiHostSessionId}):this.logger.error("scenario corresponging to excel file edit not found"),this.displayTitleBar=!1,this.isEditMode=!0,this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,this.fileName)}else this.logger.error("Switched to unknown mode: "+e.NewMode)}},e.prototype.init=function(){var e=this.getNStarViewerExpUrl();this.fileViewerExpUrl=this.$sce.trustAsResourceUrl(e)},e.prototype.getNStarViewerExpUrl=function(){var e=(this.utilityService.djb2_hash(""+this.objectUrl)||"").toString(),t=this.filesDocStageHelperService.getFilesExperienceOrigin()+"/files/apps/com.microsoft.teams.files/files/"+e+"/open";this.filesExpBaseUrl=t;var i=this.settingsService.getActiveTheme(),s=this.localizationService.getLocale(),r=this.isTabbedFile(),n={agent:"postmessage",objectUrl:this.objectUrl,fileId:this.fileId,fileType:this.fileType,messageId:this.routeDocumentViewerParams.messageId,userClickTime:this.userClickTime,ctx:this.ctx,scenarioId:this.scenario&&this.scenario.id||null,locale:s,isTabbedFile:r,theme:i,version:this.settingsService.getOrbitalVersion(this.constants.settings.orbitals.files)},o=this.settingsService.getRing(),a={"ring.id":o&&o.id||"",createdTime:Date.now()},l=t+"?"+Object.keys(n).filter(function(e){return n[e]}).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(n[e])}).join("&")+"&"+Object.keys(a).map(function(e){return"setting="+e+":"+a[e]}).join("&"),c=this.utilityService.parseUrl(l),d="iframe-container.html#iframeurl="+encodeURIComponent(this.$sce.trustAsResourceUrl(c.href))+"&skipDomainValidation=true";return this.useWebview?d:l},e.prototype.webviewProcessMessage=function(e){return this.commonMessageListner({data:e.args[1]})},e.prototype.layout=function(){if(this.webviewElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.webviewElement.clientWidth,t=this.webviewElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype.isTabbedFile=function(){var e=this.routeUtilityService.getRootRouteParams();return e&&e.middlePane&&e.middlePane.startsWith("tab::")||"pinned-tab"===this.scenario.eventData.entryPoint},e.prototype.createNewFile=function(e){if(this.isWACAppCreateNewDocumentScenarioEnabled()&&e.appID){var t=void 0;switch(e.appID){case this.constants.files.wac.applications.word:t=this.constants.files.createFileExtensions.word;break;case this.constants.files.wac.applications.excel:t=this.constants.files.createFileExtensions.excel;break;case this.constants.files.wac.applications.powerpoint:t=this.constants.files.createFileExtensions.powerpoint;break;case this.constants.files.wac.applications.visio:t=this.constants.files.createFileExtensions.visio}var i=void 0,s=void 0,r=this.personalFilesDetailsService.getPersonalSiteInfo();if(r&&(i=this.filesUtilityService.extractServerRelativeUrl(r.personalRootFolderUrl),s=r.personalSiteUrl),t&&i&&s)try{this.createFileFactory.create({fileContext:{serviceName:this.constants.files.serviceName.personal,provider:this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),threadId:void 0,listenerId:this.listenerRegistration.getId(),siteUrl:s,serverRelativeRootUrl:i,rootRelativeFolderUrl:void 0,sortedAscending:!1,pageSize:0,libraryId:"default",libraryTitle:void 0},extension:t}).execute()}catch(t){this.logger.info("Create new document from WAC failed. Error: {0}, WAC Session ID: {1}",t,e.wdUserSession),this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileCreateFailedGeneric)}else this.logger.info("Create new document from WAC failed because of missing information. extension: {0}, serverRelativeRootUrl: {1}, siteUrl: {2}, WAC Session ID: {3}",e.appID,null==i,null==s,e.wdUserSession),this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileCreateFailedGeneric)}},e.prototype.isWACAppCreateNewDocumentScenarioEnabled=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppCreateNewDocumentScenario)},e.prototype.rebootFile=function(e){if(!this.isTabbedFile()||this.isWACAppDocRebootScenarioEnabled()){this.logger.log("Reboot Mode: "+e.rebootMode);var t=this.routeDocumentViewerParams;if(this.isWACAppDocRebootScenarioEnabled())if(e.rebootMode===r.NewDocument&&e.documentUrl){t.objectUrl=e.documentUrl,t.fileId=void 0;var i=this.filesUtilityService.getFileNameFromObjectURL(t.objectUrl),n=i?this.utilityService.getFileExtension(i):void 0;t.fileType=this.isWXPExtension(n)?n:this.fileType,t.shareUrl=void 0,t.shareId=void 0,t.wacScenario=this.constants.wacScenario.rebootMRU}else e.rebootMode===r.SameDocument&&(t.rebootOverrideData=JSON.stringify({previousSessionId:e.previousSessionId,mode:e.mode,queryOverrides:e.queryOverrides,isNewSession:"true"===e.isNewSession}),t.wacScenario=this.constants.wacScenario.rebootSameDoc);var o=s({},t,{reboot:!0});this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!1);var a={documentViewerParams:o,viewerState:this.constants.states.appDocumentViewer};this.navigationService.navigateToFileViewer(a)}else this.logger.info("wrong reboot file path")},e.prototype.getWacScenarioFromRouteParams=function(){return this.routeUtilityService.getRootRouteParams().wacScenario},e.prototype.getWacSessionOrigin=function(){var e=(this.useWebview?this.constants.wacSessionOriginApp.teamsElectron:this.constants.wacSessionOriginApp.teamsWeb)+"."+this.serviceName+"."+this.ctx,t=this.getWacScenarioFromRouteParams();return t&&(e+="-"+t),e},e}();t.FileUnifiedAppViewerController=a,angular.module("teamspace.fileUnifiedAppViewer",["teamspace.layoutService","teamspace.settingsService","teamspace.constants","teamspace.loggingService","teamspace.utilityService","teamspace.filesUtilityService","teamspace.routeUtilityService","teamspace.filesDocStageHelperService","teamspace.channelService","teamspace.filesMessagePaneHelper","teamspace.messageService","teamspace.storageService","teamspace.routeChangeService","teamspace.navigationService"]).component("fileUnifiedAppViewer",{bindings:{fileType:"<",objectUrl:"<",scenario:"<",hideClose:"<?",onClose:"&?",userClickTime:"<",ctx:"<",redeemPromise:"<",driveItemCallStartTime:"<",displayTitleBar:"=",isEditMode:"=",moreOptions:"<?",hideSpinner:"<?",fileName:"<",serviceName:"<",threadId:"<",fileId:"<",moveEditInBrowserFromMoreOptions:"<"},template:n,controller:a})},2269:function(e,t){e.exports='<div id="file-unified-app-viewer" class="flex-fill" ng-focus="$ctrl.handleFocus($event)" tabindex="0">\n\n  <file-full-alert class="flex-fill" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" allow-download="$ctrl.allowDownloadOnError" entity-context="::$ctrl.entityContext">\n  </file-full-alert>\n\n  <div ng-if="!$ctrl.fileErrorCode" class="flex-fill">\n    <iframe id="file-unified-app-viewer-frame" ng-if="::!$ctrl.useWebview" ng-src="{{$ctrl.fileViewerExpUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </iframe>\n\n    <webview id="file-unified-app-viewer-webview" ng-if="::$ctrl.useWebview" ng-src="{{$ctrl.fileViewerExpUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </webview>\n  </div>\n</div>\n<div class="ts-right-rail thread-right-rail file-unified-app-viewer-conversation-panel" ng-if="$ctrl.isConversationPanelOpen">\n  <div class="file-unified-app-viewer-conversation-panel-container">\n    <div class="ts-canvas-message-pane">\n      <div class="conversation-title-bar">\n        <button class="ts-sym app-icons-fill-hover conversation-close" aria-label="{{::$root.resources.strings.files_conversation_chat_pane_close_button_aria_label| translate:{fileName:$ctrl.fileName} }}" title="{{::$root.resources.strings.files_conversation_chat_pane_close_button_tooltip | translate}}" ng-click="$ctrl.closeConversationPane()" acc-role="tab-handler-close-conversation-pane" tabindex="-1">\n          <ng-include class="icon icons-close" src="\'svg/icons-close.html\'"></ng-include>\n        </button>\n      </div>\n      <div class="file-unified-app-viewer-conversation-panel-container-body">\n        <img src="https://statics.teams.cdn.office.net/hashedassets/placeholders/zero_chat-fb38701.svg" class="files-zero-chat-icon"/>\n        <h4 class="file-empty-header-text">{{$ctrl.filesConversationEmptChatPaneHeader}}</h4>\n        <h5 class="file-empty-body-text">{{$ctrl.filesConversationEmptChatPaneBody}}</h5>\n        <div class="ts-files-start-conversation">\n          <div class="message-expander">\n            <div class="ts-files-add-message" id="add-new-message" data-tid="channelNewMessageContainer" ng-disabled="!$ctrl.canPostConversation">\n              <new-message send-message="$ctrl.initiateConversation(messageData, scenario)" message-type="::$ctrl.messageType" hide-people-picker="false" conversation-id="::$ctrl.threadId">\n              </new-message>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>'},2270:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var r=i(2271),n=function(){function e(e,t,i,s,r,n,o,a,l,c,d,h,p,u,v,f,m,g,w){var y=this;this.$scope=e,this.$window=i,this.$q=s,this.$timeout=n,this.$cookies=o,this.constants=a,this.loggingService=l,this.settingsService=c,this.utilityService=d,this.authenticationService=h,this.appConfig=p,this.eventingService=u,this.filesActionService=f,this.filesUtilityService=m,this.appStateService=g,this.sharepointShareService=w,this.postMessageId="teams",this.clientId="MicrosoftTeams",this.webViewElement=null,this.loadingComplete=!0,this.encounteredRedirectError=!1,this.logger=l.newLogger("FileViewer"),this.initialActiveElement=document.getElementById("file-office-frame-container")||window,this.isDesktopApp=c.valueAsBoolean(a.settings.names.isDesktopApp);var S=!1,b=!1,I=!1;i&&i.desktopSettings&&(S=i.desktopSettings.enableWebviewPreload,b=i.desktopSettings.enableWebviewSandbox,I=i.desktopSettings.enableTabWebviews),this.useWebView=c.valueAsBoolean(a.settings.names.filesEnableOneUpWebview)&&this.isDesktopApp&&!!i.electronSafeIpc&&(S&&b||I),this.oneUpServiceUrl=t.trustAsResourceUrl(this.getOneUpServiceUrl()),this.webViewSrc="",this.host=d.parseUrl(r.absUrl()).origin,this.currentLocale=v.getLocale(),e.$on("$destroy",function(){y.removeListeners(),y.scenario.cancel()}),this.mandatoryPropertyMissingOrPreviewNotAvailable()||(this.useWebView?this.initWebView():this.getAuthToken().then(function(e){y.initFrame(e)}),this.ensureInitialFocusIsNotStolen())}return e.$inject=["$scope","$sce","$window","$q","$location","$timeout","$cookies","constants","loggingService","settingsService","utilityService","authenticationService","appConfig","eventingService","localizationService","filesActionService","filesUtilityService","appStateService","sharepointShareService"],e.prototype.initWebView=function(){var e=this,t=this.$window.electronSafeIpc;t&&this.useWebView&&(t.send(this.constants.events.desktopApp.allowWebViewCreate,{enablePreload:!0}),t.once(this.constants.events.desktopApp.webViewCreationEnabled,function(){e.webViewElement=window.document.getElementById("file-one-up-viewer-webview"),e.messageSource=e.webViewElement;e.addListener("ipc-message",function(t){return e.webviewProcessMessage(t)});e.addListener("crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.crashed,{errorEvent:JSON.stringify(t)})});e.addListener("gpu-crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.gpuCrashed,{errorEvent:JSON.stringify(t)})});e.addListener("plugin-crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.pluginCrashed,{errorEvent:JSON.stringify(t)})});e.addListener("did-fail-load",function(t){e.loggingService.event(e.constants.telemetry.webview.loadFailed,{errorEvent:JSON.stringify({errorCode:t?t.errorCode:null,errorDescription:t?t.errorDescription:null})})});e.addListener("did-finish-load",function(t){return e.scenario.eventData=s({},e.scenario.eventData,{frameLoaded:!0})});var t=e.layout.bind(e);e.addListener("dom-ready",t),e.$window.addEventListener("resize",t),e.$scope.$on("$destroy",function(){e.$window.removeEventListener("resize",t)}),e.webViewSrc="iframe-container.html#iframeurl=about:blank&processTag="+e.constants.files.strings.oneup}))},e.prototype.layout=function(){if(this.webViewElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.webViewElement.clientWidth,t=this.webViewElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype.addListener=function(e,t){this.webViewElement?this.webViewElement.addEventListener(e,t):window.addEventListener(e,t),this.listeners||(this.listeners={}),this.listeners[e]=t},e.prototype.removeListeners=function(){for(var e in this.listeners)this.webViewElement?this.webViewElement.removeEventListener(e,this.listeners[e]):window.removeEventListener(e,this.listeners[e]);this.listeners=null},e.prototype.webviewProcessMessage=function(e){if((e&&e.channel)===this.constants.webViewShim.postMessageFromWebview){var t=e.srcElement||e.target;if(this.webViewElement===t)if(!e.args||e.args.length<2)this.logger.error("OneUp viewer did not receive all the params");else{var i=e.args&&e.args[0];window&&window.location&&window.location.origin===i?this.handlePostMessageFromContainer(e.args[1]):this.oneUpServiceOrigin===i?this.handlePostMessage({origin:e.args[0],data:e.args[1],source:this.webViewElement}):this.logger.error("invalid event origin {0}",i)}else this.logger.error("OneUp viewer received message from a different webview")}},e.prototype.handlePostMessageFromContainer=function(e){if(e&&e.func){if("iframeLoaded"===e.func)return void this.postFormToWebview();if("error"===e.func)return void this.handleCurrentWindowErrorMessage(e)}},e.prototype.postFormToWebview=function(){var e=this;this.getAuthToken().then(function(t){e.embedParams=e.getEmbedParams(t),e.oneUpServiceOrigin=e.utilityService.parseUrl(e.oneUpServiceUrl).origin,e.encounteredRedirectError=!1,e.webViewElement.send(e.constants.webViewShim.postFormToWebview,{url:e.getOneUpServiceUrl(),params:{context:e.embedParams}})})},e.prototype.handleCurrentWindowErrorMessage=function(e){var t="";try{t=JSON.stringify(e.args)}catch(e){t=e.toString()}this.logger.error("received errorCode: {0}, errorMessage {1} for oneup viewer","IPC error",t),this.handleError("IPC error",t)},e.prototype.initFrame=function(e){var t=this,i=this.settingsService.valueAsBoolean(this.constants.settings.names.enableOneUpCallOnIframeOnLoadEvent);this.encounteredRedirectError=!1;var r=document.getElementById("file-one-up-viewer-frame"),n=document.getElementById("file-one-up-viewer-form"),o=document.getElementById("file-one-up-viewer-context"),a=!1;r&&(this.messageSource=r.contentWindow),this.embedParams=this.getEmbedParams(e);r.onload=function(e){i&&(!a&&n.submit(),a=!0),t.scenario.eventData=s({},t.scenario.eventData,{frameLoaded:!0})};try{o.value=JSON.stringify(this.embedParams)}catch(e){this.logger.error("Exception in stringfying embed params correlationId {0} ",this.embedParams.correlationId),this.errorCode=this.constants.files.error.invalidArguments}this.registerPostMessageHandler(),!i&&n.submit()},e.prototype.getEmbedParams=function(e){var t={id:this.postMessageId,o:this.host,ct:(new Date).getTime()},i=this.getOneUpThemePayload();return{authToken:e,webUrl:this.siteUrl,UniqueId:this.fileId&&this.fileId.replace(/{|}/g,""),id:this.serverRelativeUrl,embed:JSON.stringify(t),culture:this.currentLocale,client_id:this.clientId,correlationId:this.loggingService.sessionId+"-"+this.scenario.id,useHostDownload:!0,theme:i,item:this.driveItem}},e.prototype.getOneUpThemePayload=function(){var e={themePrimary:"#6264a7",themeDark:"#293370"},t={buttonPrimaryTextHovered:"#fff",buttonPrimaryTextFocused:"#fff"};return(this.$cookies.get(this.constants.themes.cookieName)||this.constants.themes.default)===this.constants.themes.highContrast&&(e.themePrimary="#000",e.themeDark="#ffff01",e.neutralLighter="#fff",t.buttonPrimaryTextFocused="#252424",t.buttonPrimaryTextHovered="#252424"),{palette:e,semanticColors:t}},e.prototype.getOneUpServiceUrl=function(){var e=this.appConfig.oneUpServiceConstants.host,t=this.appConfig.oneUpServiceConstants.devHost;return t&&(e=e+"?devHost="+t),e},e.prototype.getAuthToken=function(e){var t=this,i=this.utilityService.parseUrl(this.siteUrl).origin;return this.filesUtilityService.updateTokenWarmingRule(i),this.authenticationService.getAuthTokens([i],e?[e]:void 0).catch(function(e){t.logger.error("Failed fetching the AuthToken. Error: {0}",e);var i=e===t.constants.events.appState.reasons.resourceDisabled;return i?t.handleError(t.constants.files.error.invalidResource,"Invalid SPO Object URL",void 0,i):t.handleError(""+t.constants.responseCode.unauthorizedAccess,t.constants.files.error.unauthorizedAccessException),t.fileErrorCode=t.constants.files.error.unknown,t.$q.reject(e)})},e.prototype.registerPostMessageHandler=function(){var e=this;this.removeListeners();this.addListener("message",function(t){return e.handlePostMessage(t.originalEvent||t)})},e.prototype.handlePostMessage=function(e){var t=this,i=e,s=this.utilityService.parseUrl(this.oneUpServiceUrl).origin,r="[OneDrive:From:Embed:"+this.postMessageId+"]";if(i&&i.origin&&i.origin.toLowerCase()===s.toLowerCase()&&i.source===this.messageSource&&_.startsWith(i.data,r)){var n=i.data.substr(r.length),o=JSON.parse(n||"{}");switch(o.type){case"success":var a=o;this.logger.info("success callback from oneUp {0}",a),this.stopScenario(a.previewType,a.conversationId);break;case"error":var l=o,c=l.error?l.error.code:this.constants.files.error.unknownOneUp,d=l.error?l.error.message:this.constants.files.error.unknownOneUp,h=this.settingsService.valueAsBoolean(this.constants.settings.names.enableRetryOnRedirectErrorForOneUp);this.logger.info("error callback from oneUp {0}",l),h&&o&&"RedirectError"===o.data?(this.scenario.eventData.specialCase=this.constants.errorCodes.invalidAudienceUri,this.encounteredRedirectError=!0,this.reloadFileOnRedirectError(l.conversationId)):!this.encounteredRedirectError&&this.handleError(c,d,l.conversationId,l.isExpected);break;case"download":if(this.serviceName&&this.fileDetail){var p={serviceName:this.serviceName,getContextBase:function(){return t.filesUtilityService.getContextBase(t.fileDetail,t.serviceName,void 0,t.fileDetail.objectUrl,!1)}};this.filesActionService.execute(teamspace.services.EntityActionType.Download,this.fileDetail,p)}else this.loggingService.error("oneUp download failed because fileDetail or serviceName undefined for scenario "+this.scenario.id)}i.source&&void 0!==o.conversationId&&this.postAckMessage(i.source,o.conversationId)}},e.prototype.reloadFileOnRedirectError=function(e){var t=this;this.scenario.mark("get_updated_site_url_start"),this.sharepointShareService.getSiteResourceInfo(this.siteUrl).then(function(i){t.scenario.mark("get_updated_site_url_end"),i!==t.siteUrl?(t.updateOneUpParams(i),t.useWebView?t.postFormToWebview():t.getAuthToken().then(function(e){t.initFrame(e)})):(t.scenario.mark("updated_site_unchanged"),t.scenario.eventData.specialCase=null,t.handleError(t.constants.errorCodes.invalidMultiGeoCase,"Retry not needed. Not true multi geo case",e,!1))}).catch(function(i){t.scenario.mark("get_updated_site_url_fail"),t.fileErrorCode=i.statusCode||i.errorCode,t.handleError("GRAPH_"+(i.statusCode||i.errorCode),i.errorMessage,e,!1)})},e.prototype.updateOneUpParams=function(e){this.siteUrl=e;var t=this.utilityService.parseUrl(this.siteUrl).origin,i=this.utilityService.parseUrl(this.objectUrl).pathname;this.fileDetail=s({},this.fileDetail,{siteUrl:e,objectUrl:""+t+i})},e.prototype.postAckMessage=function(e,t){if(e){var i={type:"acknowledge",conversationId:t},s="[OneDrive:To:Embed:"+this.postMessageId+"]"+JSON.stringify(i);if(this.useWebView&&this.webViewElement)this.webViewElement.send(this.constants.webViewShim.postMessageToWebview,s);else{var r=this.utilityService.parseUrl(this.oneUpServiceUrl).origin;e.postMessage(s,r)}}},e.prototype.stopScenario=function(e,t){this.loadingComplete=!0,this.eventingService.$emit(this.constants.events.files.fileOneUpViewerLoaded,{conversationId:t,previewType:e,useWebview:this.getUseWebViewFlag(),scenario:this.scenario})},e.prototype.mandatoryPropertyMissingOrPreviewNotAvailable=function(){if(!this.siteUrl||!this.serverRelativeUrl&&!this.fileId){e=this.siteUrl?"Invalid ServerRelativeURL and FileId":"Invalid SiteURL";return this.logger.error(e),this.errorCode=this.constants.files.error.invalidArguments,this.handleError(this.errorCode,e),!0}if(this.previewAvailable=this.filesUtilityService.isOneUpSupportedFile(this.type),!this.previewAvailable){this.fileErrorCode=this.constants.errorCodes.previewNotAvailable,this.entityContext={id:this.fileId,objectUrl:this.objectUrl,serviceName:this.serviceName,title:this.fileDetail.title};var e="File Preview not available";return this.handleError(this.fileErrorCode,e,null,!0),!0}return!1},e.prototype.handleError=function(e,t,i,s){this.loadingComplete=!0,(!this.appStateService.isOnline||!this.appStateService.isConnected)&&(e=this.fileErrorCode=this.constants.errorCodes.networkOffline,t="Network is offline",s=!0),s||this.checkIfExpectedFailure(e)?this.scenario.incomplete({errorCode:e,errorMessage:t,conversationId:i,useWebview:this.getUseWebViewFlag(),isExpectedFailure:this.constants.files.isExpectedFailure.yes}):this.scenario.fail({errorCode:e,errorMessage:t,conversationId:i,useWebview:this.getUseWebViewFlag()})},e.prototype.checkIfExpectedFailure=function(e){var t=this.constants.responseCode;return-1!==[t.unauthorizedAccess,t.forbidden,t.notFound,t.notAcceptable].indexOf(Number(e))},e.prototype.getUseWebViewFlag=function(){return this.useWebView?"true":"false"},e.prototype.ensureInitialFocusIsNotStolen=function(){var e=this,t=angular.element(this.$window);this.onWindowBlur&&(t.unbind(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler()),this.onWindowBlur=function(t){return e.onWindowBlurHandler(t)},t.on(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler=this.$scope.$on("$destroy",function(){t.unbind(e.constants.events.jQuery.blur,e.onWindowBlur)})},e.prototype.onWindowBlurHandler=function(e){var t=this;angular.element(this.$window).unbind(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler(),this.onWindowBlur=null,this.$timeout(function(){return angular.element(t.initialActiveElement).focus()},100,!1)},e}();angular.module("teamspace.fileOneUpViewer",["teamspace.settingsService","teamspace.utilityService","teamspace.authenticationService"]).component("fileOneUpViewer",{bindings:{scenario:"<",type:"<",siteUrl:"<",serverRelativeUrl:"<",fileDetail:"<",serviceName:"<",driveItem:"<",fileId:"<",objectUrl:"<"},template:r,controller:n})},2271:function(e,t){e.exports='<div id="file-one-up-viewer" class="flex-fill">\n\n  <div ng-if="!$ctrl.loadingComplete">\n      <busy-animation size="medium" context="file-one-up-viewer">\n      </busy-animation>\n  </div>\n\n  <file-full-alert class="flex-fill" object-url="{{$ctrl.objectUrl}}" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" entity-context="::$ctrl.entityContext">\n  </file-full-alert>\n\n  <div ng-style="{\'visibility\' : $ctrl.loadingComplete ? \'visible\' : \'hidden\'}" ng-if="!$ctrl.fileErrorCode" class="flex-fill">\n    <form id="file-one-up-viewer-form" target="file-one-up-viewer-frame" method="POST" action="{{$ctrl.oneUpServiceUrl}}" hidden>\n      <input id="file-one-up-viewer-context" type="text" name="context"/>\n      <input type="submit"/>\n    </form>\n\n    <iframe id="file-one-up-viewer-frame" name="file-one-up-viewer-frame" ng-if="::!$ctrl.useWebView" ng-src="about:blank" sandbox="allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </iframe>\n\n    <webview id="file-one-up-viewer-webview" ng-if="::$ctrl.useWebView" ng-src="{{$ctrl.webViewSrc}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </webview>\n  </div>\n</div>\n'},2272:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var r=i(2273),n=function(){function e(e,t,i,s,r,n,o,a,l,c,d,h,p,u,v,f,m,g,w,y,S,b,I,C){var E=this;this.$q=e,this.$scope=t,this.$state=i,this.$translate=s,this.constants=r,this.resources=n,this.loggingService=o,this.utilityService=a,this.routeUtilityService=l,this.filesEntityService=c,this.filesUtilityService=d,this.filesActionService=h,this.analyticsService=p,this.filesActionRouter=u,this.filesProviderFactory=v,this.settingsService=f,this.sharepointScenarioHandler=m,this.sharePointFilePreviewService=g,this.filesRedeemService=y,this.navigationService=S,this.filesDocStageHelperService=I,this.filesSharingHelper=C,this.isPreProcessingComplete=void 0,this.useNStarViewerExpInMainWindow=!1,this.displayTitleBar=!0,this.showSpinner=!0,this.moveEditInBrowserFromMoreOptions=!1,this.scenarioComplete=!1,this.fileDetailsFetchSuccess=!1,this.logger=o.newLogger("FileViewer");var U=l.getRootRouteParams();this.ctx=U.ctx?decodeURIComponent(U.ctx):void 0,this.accessType=U.accessType;var T;!this.objectUrl||U.fileName&&this.fileType||(T=d.getFileNameFromObjectURL(this.objectUrl)),this.fileName=U.fileName?U.fileName:T,this.fileId=this.fileId&&this.fileId.replace(/{|}/g,""),!this.shareUrl&&U.shareUrl&&(this.shareUrl=U.shareUrl),!this.shareId&&U.shareId&&(this.shareId=U.shareId),C.shareLogInfo(r.files.actionLogs.fileOpen,this.fileId,this.shareUrl?"shareUrl exists":"shareUrl does not exist"),this.isNewFile=this.ctx===r.scenarios.files.newFileCreationContext;var P=f.valueAsBoolean(r.settings.names.filesEnableSharePointFilePreviewService);i.current.name!==r.states.appDocumentViewer&&i.current.name!==r.states.appAppsAppFileSection||U.viewerAction!==r.files.fileActions.viewer.edit?(this.viewerType=P?g.getPreviewerType(this.fileType):teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Wac,this.wacEdit=!1):(this.viewerType=P?g.getEditorType(this.fileType):teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Wac,this.wacEdit=!0);var $=this.getActionType();if(this.objectUrl&&d.isNStarViewerExpInMainWindowEnabled(this.fileType)&&b.getBrowser()!==r.browser.ie&&(this.wacEdit=!a.isVisioFile(this.fileType)||$===r.wopiActions.edit,this.useNStarViewerExpInMainWindow=!0,d.isIntegratedUXEnabled(this.fileType)&&(this.displayTitleBar=$===r.wopiActions.view||!a.isVisioFile(this.fileType)&&!this.wacEdit),this.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,this.fileType===r.fileExtensions.email&&(this.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email,this.setFileDetails()),this.hideSpinner=function(){return E.showSpinner=!1}),w.$on(t,r.events.files.fileOneUpViewerLoaded,function(e,t){E.oneUpViewerLoadSucessMessage=t,E.stopScenario()}),this.useOneUp=this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.OneUp,this.scenario=o.findScenario(this.scenarioName),this.scenario||(o.warn("file-office-frame: could not find scenario"),this.scenario=o.newScenario(this.scenarioName,null,function(){E.scenarioComplete=!0},r.timeInMiliseconds.tenMinutes),this.scenario.eventData={type:this.fileType,entryPoint:this.ctx,serviceName:this.serviceName}),this.scenario.eventData.viewerType=this.viewerType,this.scenario.eventData.type=d.scrubUnknownFileExtensions(this.fileType),this.scenario.eventData.isShareUrlPresent=!!this.shareUrl,this.logger.info("sessionId {0} scenarioId {1} viewerType {2}",o.sessionId,this.scenario.id,this.viewerType),this.baseUrl||(this.baseUrl=d.extractSiteUrl(this.objectUrl)),this.useOneUp&&(this.oneUpParams={baseUrl:this.baseUrl,fileType:this.fileType,scenario:this.scenario,serverRelativeUrl:d.extractServerRelativeUrl(this.objectUrl)}),t.$on("$destroy",function(){E.scenarioComplete||E.scenario.cancel()}),this.logger.info("type {0} isOneUp {1} isUnified {2}",this.fileType,this.useOneUp,this.useNStarViewerExpInMainWindow),this.useOneUp&&!a.isDocumentType(this.fileType))return this.setFileDetails(),void this.redeemFile(this.viewerType,U,T,$,!1);this.useNStarViewerExpInMainWindow?this.redeemFile(this.viewerType,U,T,$,!1):this.redeemFile(this.viewerType,U,T,$)}return e.$inject=["$q","$scope","$state","$translate","constants","resources","loggingService","utilityService","routeUtilityService","filesEntityService","filesUtilityService","filesActionService","analyticsService","filesActionRouter","filesProviderFactory","settingsService","sharepointScenarioHandler","sharePointFilePreviewService","eventingService","filesRedeemService","navigationService","platformDetectService","filesDocStageHelperService","filesSharingHelper"],e.prototype.getActionType=function(){if(this.isNewFile)return this.constants.wopiActions.editNew;var e=this.utilityService.getIconClass({type:this.fileType}),t=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDefaultToROViewUnifiedAppWord);switch(e){case this.constants.css.fileIcons.word:return t?this.constants.wopiActions.view:this.constants.wopiActions.open;case this.constants.css.fileIcons.excel:return this.constants.wopiActions.open;case this.constants.css.fileIcons.powerpoint:return this.constants.wopiActions.edit;case this.constants.css.fileIcons.visio:return this.wacEdit?this.constants.wopiActions.edit:this.constants.wopiActions.open;default:return}},e.prototype.redeemFile=function(e,t,i,s,r){var n=this;void 0===r&&(r=!0);var o=this.useNStarViewerExpInMainWindow?teamspace.services.IFileRedeemScenario.NorthStarFileViewer:teamspace.services.IFileRedeemScenario.Thumbnail;if(this.logger.info("isDetailCallNeeded {0} isShareUrl {1} isNStarViewerExperience {2}",r,this.shareUrl,this.useNStarViewerExpInMainWindow),this.shareUrl||this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp){var a={fileId:this.fileId,shareId:this.shareId},l=this.settingsService.valueAsBoolean(this.constants.settings.names.enableInValidAudienceErrorRetryForUnifiedApps)&&(this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp||this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.OneUp);this.scenario.mark("redeem-call-started"),this.driveItemCallStartTime=Date.now(),this.redeemPromise=this.filesRedeemService.redeemFile(this.objectUrl,this.shareUrl,o,s,a,this.baseUrl,l,this.scenario.name),this.redeemPromise.then(function(s){n.scenario.mark("redeem-call-finished"),n.driveItem=s,n.isPreProcessingComplete=!0,r&&n.fetchFileDetailsAndSetHeaders(e,t,i)}).catch(function(e){if(n.scenario.mark("redeem-call-failed"),!n.scenario.eventData.SPRequestId){var t=e&&e.errorMessage&&e.errorMessage.error&&e.errorMessage.error.innerError;n.scenario.eventData.SPRequestId=t&&t["request-id"]}n.onFileLoadError(e,!0)}).finally(function(){if(n.setFileDetails(),n.useNStarViewerExpInMainWindow){if(n.isPreProcessingComplete&&!n.isValidDriveItem(n.driveItem,n.fileType)){n.scenario.mark("redeem-call-incomplete");var e={statusCode:200,message:"jsAPI parameters missing in driveItem API response"};return n.logger.error("jsapi params missing in redeem call response"),void n.onFileLoadError(e,!0)}n.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp&&n.isValidDriveItem(n.driveItem,n.fileType)&&fetch(n.driveItem.openWith.wac.bootstrapperUrl).then(function(e){var t=performance.getEntriesByName(n.driveItem.openWith.wac.bootstrapperUrl).slice(-1)[0],i=t?{latency:t.duration,cached:0===t.transferSize}:void 0;n.scenario.mark("JSAPI script prefetched",i)}).catch(function(e){n.scenario.mark("JSAPI prefetch failed")})}})}else this.isPreProcessingComplete=!0,r&&this.fetchFileDetailsAndSetHeaders(e,t,i)},e.prototype.isValidDriveItem=function(e,t){return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email||!!(this.driveItem&&this.driveItem.openWith&&this.driveItem.openWith.wac)},e.prototype.fetchFileDetailsAndSetHeaders=function(e,t,i){var s,r=this,n=this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),o=this.filesActionRouter.getItemDetailsRepository(n),a=!0;(this.useNStarViewerExpInMainWindow||this.isNStarViewerType())&&(a=!1);var l=t.rootContext?decodeURIComponent(t.rootContext):void 0;if(this.getByFileIdAndBaseUrl(l)){var c=this.fileType?this.fileType:this.utilityService.getFileExtension(i);s=o.getById(this.baseUrl,this.fileId,c===this.constants.onenote.extension,this.isNewFile,a)}else s=this.objectUrl?o.getByUrl(this.objectUrl,a):this.$q.reject(teamspace.services.files.FilesError.createFromInternalError(this.constants.files.internalErrorCodes.common.argumentError,"File is not specified."));s.then(function(e){r.scenario.mark("details-call-finished"),r.fileDetail=e.value,r.fileDetail.size&&(r.scenario.eventData.size=r.utilityService.bytesToMb(r.fileDetail.size)),r.useOneUp||(r.wacUrl=r.wacEdit?r.fileDetail.wacUrlEdit:r.fileDetail.wacUrl),r.fileName||(r.fileName=r.fileDetail.title);var t=r.getSiteUrlFromFileDetails(r.fileDetail);if(t=decodeURIComponent(t),r.baseUrl!==t&&(r.baseUrl=t),r.useOneUp){if(!r.oneUpParams){var i=decodeURIComponent(r.fileDetail.objectUrl);r.oneUpParams={baseUrl:t,fileType:r.fileType,scenario:r.scenario,serverRelativeUrl:r.filesUtilityService.extractServerRelativeUrl(i)}}r.oneUpParams.fileDetail=r.fileDetail,r.oneUpParams.serviceName=r.serviceName}return r.fileDetail}).then(function(e){r.initializeTitleAndStopScenario()}).catch(function(e){r.logger.error("Error in details call"),r.onFileLoadError(e,!1,!0)})},e.prototype.setFileDetails=function(){var e=this.objectUrl;this.isPreProcessingComplete&&this.driveItem&&this.driveItem.webUrl&&(e=this.driveItem.webUrl),this.fileDetail={objectId:this.fileId,objectUrl:this.driveItem&&this.driveItem.webDavUrl?this.driveItem.webDavUrl:this.objectUrl,title:this.driveItem&&this.driveItem.name?this.driveItem.name:this.fileName,type:this.fileType,wacUrl:"",wacUrlEdit:"",openInWindowFileUrl:e,isPersonal:this.serviceName===this.constants.files.serviceName.personal,siteUrl:this.driveItem&&this.driveItem.sharepointIds&&this.driveItem.sharepointIds.siteUrl?this.driveItem.sharepointIds.siteUrl:this.baseUrl},this.oneUpParams&&(this.oneUpParams.fileDetail=this.fileDetail,this.oneUpParams.serviceName=this.serviceName,this.driveItem&&this.driveItem.webDavUrl&&this.objectUrl!==this.driveItem.webDavUrl&&(this.scenario.mark("oneup-params-updated-with-driveitem"),this.objectUrl=this.driveItem.webDavUrl,this.oneUpParams.baseUrl=this.filesUtilityService.extractSiteUrl(this.objectUrl),this.oneUpParams.serverRelativeUrl=this.filesUtilityService.extractServerRelativeUrl(this.objectUrl))),this.initializeTitleAndStopScenario()},e.prototype.initializeTitleAndStopScenario=function(){this._initializeTitleBar(),this.fileDetailsFetchSuccess=!0,this.stopScenario()},e.prototype.getByFileIdAndBaseUrl=function(e){return this.baseUrl&&this.fileId&&(e===this.constants.scenarios.files.itemsViewRootContext||this.fileType!==this.constants.onenote.extension)},e.prototype.getSiteUrlFromFileDetails=function(e){return e&&e.objectUrl||this.onFileLoadError({errorCode:void 0,internalErrorCode:""+this.constants.files.internalErrorCodes.common.invalidUrl,statusCode:200},!1,!0),e.siteUrl?e.siteUrl:(e.parentListUrl||this.onFileLoadError({errorCode:void 0,internalErrorCode:""+this.constants.files.internalErrorCodes.sharepoint.missingListUrl,statusCode:200},!1,!0),this.filesUtilityService.extractSiteUrl(e.objectUrl,e.parentListUrl))},e.prototype.stopScenario=function(){if(this.oneUpViewerLoadSucessMessage&&this.fileDetailsFetchSuccess&&this.oneUpParams&&this.oneUpParams.scenario&&this.oneUpViewerLoadSucessMessage.scenario===this.scenario){var e={conversationId:this.oneUpViewerLoadSucessMessage.conversationId,previewType:this.oneUpViewerLoadSucessMessage.previewType,useWebview:this.oneUpViewerLoadSucessMessage.useWebview};this.oneUpParams.scenario.stop(e)}},e.prototype._initializeTitleBar=function(){var e=this;if(this.fileDetail&&!this.isSPOUrlInvalid){var t={serviceName:this.serviceName,getContextBase:function(){return e.filesUtilityService.getContextBase(e.fileDetail,e.serviceName,void 0,e.fileDetail.objectUrl,!1)}},i=this.filesActionService.isReadOnlyNotTeamOwner({accessType:this.accessType,threadId:this.threadId}),r=this.filesEntityService.getOpenInText(this.fileDetail.type),n=this.settingsService.valueAsBoolean(this.constants.settings.names.filesEnableSharePointFilePreviewService),o=this.utilityService.getIconClass({type:this.fileType}),a=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDefaultToROViewUnifiedAppWord),l=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDirectDiscoveryOfEditInBrowser);if(this.moveEditInBrowserFromMoreOptions=o===this.constants.css.fileIcons.word&&a&&l,this.moveEditInBrowserFromMoreOptions)this.wacEdit=!1,this.editAction=function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,s({},t,{isWordROAndOpenInBrowserEnabled:e.moveEditInBrowserFromMoreOptions}))},this.titleBarPrimaryOptions={primaryButtonText:this.$translate.instant(this.resources.strings.files_editButtonLabel),primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonLabel)};else if(this.filesUtilityService.isVisioDesktopAppOnlyEditEnabled(this.fileDetail.type)){this.editAction=function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)};var c=this.filesUtilityService.getProductLabels(this.fileDetail.type);this.titleBarPrimaryOptions={primaryButtonText:c.desktopProductName,primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonAriaLabelVisio)}}else{var d=this.settingsService.valueAsBoolean(this.constants.settings.names.enableOfficeViewerEdit);d&&(this.editAction=function(){return e.changeToEdit()});var h=i?this.resources.strings.files_menuLabelOpenInTeams:this.resources.strings.files_menuLabelEditInTeams,p=d&&(!n||this.sharePointFilePreviewService.canEditFileInTeams(this.fileDetail.type)),u={id:"office-edit-in-teams",displayName:this.$translate.instant(h),class:"open-in-teams-entry",click:function(){return e.changeToEdit()},shouldBeHidden:function(){return!p},svgPath:"svg/icons-msft-teams.html"},v=n?this.sharePointFilePreviewService.canEditFileInDesktopApp(this.fileDetail.type)&&this.fileDetail.objectUrl:this.filesActionService.canUse(teamspace.services.EntityActionType.OpenInDesktopApp,this.fileDetail,{serviceName:this.serviceName}),f={id:"office-open-in-desktop-app",displayName:r.openInDesktopAppText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)},shouldBeHidden:function(){return!v},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"},m=n?this.sharePointFilePreviewService.canEditFileInSharePoint(this.fileDetail.type)&&this.fileDetail.openInWindowFileUrl:this.filesActionService.canUse(teamspace.services.EntityActionType.OpenInNewTab,this.fileDetail,{serviceName:this.serviceName});this.openInNewTabMenuItem={id:"office-open-in-new-tab",displayName:r.openInNewTabText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,t)},shouldBeHidden:function(){return!m},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"};var g=i?this.resources.strings.files_openButtonLabel:this.resources.strings.files_editButtonLabel;this.titleBarPrimaryOptions={primaryButtonText:this.$translate.instant(g),primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonAriaLabel),dropdownButtonText:this.$translate.instant(this.resources.strings.files_moreEditOptionsButtonLabel),options:[u,f,this.openInNewTabMenuItem]}}this.titleBarMoreOptions=[{id:"download-office-document",displayName:this.$translate.instant(this.resources.strings.files_menuLabelDownload),click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.Download,e.getDownloadTarget(),t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.Download,e.fileDetail,{serviceName:e.serviceName})},svgPath:"svg/icons-download.html"},{id:"open-office-document-in-sharepoint",displayName:this.filesActionService.textFor(teamspace.services.EntityActionType.OpenInSharePoint,{serviceName:this.serviceName}),click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInSharePoint,e.fileDetail,null)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInSharePoint,e.fileDetail,{serviceName:e.serviceName})},svgPath:"svg/"+this.filesActionService.iconFor(teamspace.services.EntityActionType.OpenInSharePoint,this.fileDetail,{serviceName:this.serviceName}).first+".html"},{id:"office-open-in-desktop-app",displayName:r.openInDesktopAppText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,{serviceName:e.serviceName})||!e.moveEditInBrowserFromMoreOptions&&!e.wacEdit},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"},{id:"office-open-in-new-tab",displayName:r.openInNewTabText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,{serviceName:e.serviceName})||!!e.moveEditInBrowserFromMoreOptions||!e.wacEdit},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"}],this.threadId&&(this.titleBarConversationInfo={threadId:this.threadId,objectId:this.fileDetail.objectId,serviceName:this.serviceName,objectUrl:this.fileDetail.objectUrl})}},e.prototype.getDownloadTarget=function(){return{objectId:this.fileId,title:this.driveItem&&this.driveItem.name?this.driveItem.name:this.fileName,objectUrl:this.driveItem&&this.driveItem.webDavUrl?this.driveItem.webDavUrl:this.objectUrl,serviceName:this.serviceName,shareUrl:this.shareUrl,shareId:this.shareId,siteUrl:this.driveItem&&this.driveItem.sharepointIds&&this.driveItem.sharepointIds.siteUrl?this.driveItem.sharepointIds.siteUrl:this.baseUrl}},e.prototype.getAccessibleIframeNotice=function(){if(this.openInNewTabMenuItem)return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp?this.$translate.instant(this.resources.strings.files_accessible_iframe_notice):this.$translate.instant(this.resources.strings.files_inaccessible_iframe_notice)},e.prototype.openInNewTab=function(e){e.which===this.constants.keyCodes.enter&&e.target===e.currentTarget&&(this.openInNewTabMenuItem.click(),e.preventDefault(),this.analyticsService.onPanelAction(this.$scope,{action:{gesture:teamspace.components.PanelActionGesture.click,scenario:teamspace.components.PanelActionScenario.openFile,scenarioType:teamspace.components.PanelActionScenarioType.files},module:{name:teamspace.shared.AttributeHelper.tryGetEnum(teamspace.components.PanelModuleName.documentStage.toString(),teamspace.components.PanelModuleName,this.loggingService).toString(),type:teamspace.components.PanelModuleType.viewer,summary:"Opening document from accessible iframe wrapper"},dataBag:{wacAccessibilityOpenOnline:!0}}))},e.prototype.changeToEdit=function(){var e=this;if(this.scenarioComplete||this.scenario.cancel({errorCode:"changeToEdit"}),this.scenarioComplete=!1,this.scenario=this.loggingService.newScenario(this.constants.scenarios.files.editFileFullScreen+"_"+this.serviceName,null,function(){e.scenarioComplete=!0}),this.scenario.eventData={type:this.fileType,entryPoint:this.ctx,serviceName:this.serviceName,viewerType:this.viewerType},this.$state.current.name==this.constants.states.appDocumentViewer){var t=this.routeUtilityService.getRootRouteParams();t.viewerAction=this.constants.files.fileActions.viewer.edit;var i={documentViewerParams:t,viewerState:this.constants.states.appDocumentViewer};this.navigationService.navigateToFileViewer(i,{location:"replace",notify:!1})}this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp?(this.filesDocStageHelperService.sendPostMessage({eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:{MessageId:"Host_SwitchMode",SendTime:Date.now(),Values:{NewMode:"edit"}}}),this.displayTitleBar=!1,this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,this.fileName)):this.wacUrl=this.fileDetail.wacUrlEdit,this.wacEdit=!0,this.utilityService.isEditableVisioFileExtension(this.fileType)&&this.fileDetail.openInWindowFileUrl.includes("action=default")&&(this.fileDetail.openInWindowFileUrl=this.fileDetail.openInWindowFileUrl.replace("action=default","action=edit"))},e.prototype.onFileLoadError=function(e,t,i){void 0===t&&(t=!1),void 0===i&&(i=!1),this.isSPOUrlInvalid=this.checkForInvalidSPOUrl(e),this.isSPOUrlInvalid?this.fileErrorCode=this.constants.files.error.unknown:this.fileErrorCode=e&&(e.statusCode||e.errorCode||e.internalErrorCode||e.code)||this.constants.files.error.unknown;var s=_.get(e,"errorMessage.error");if(this.errorReasonForTelemetry=s&&s["error.errorMessage.error"],t||i){if(!e)return void this.scenario.fail({errorCode:"Unknown Error"});if(e.code===this.constants.errorCodes.networkOffline)return void this.scenario.incomplete({errorCode:e.code,errorMessage:e.message});var r=e.statusCode,n=e.message||e.errorMessage||e.internalErrorCode||this.errorReasonForTelemetry||this.fileErrorCode;if(!r)return void this.scenario.fail({errorCode:e.errorCode,errorMessage:n});if("number"!=typeof r){var o="type: "+typeof r+", status: "+r;return n=n?o+", message: "+n:o,void this.scenario.fail({errorCode:"Invalid status code type",errorMessage:n})}switch(r){case this.constants.responseCode.clientFailure:case this.constants.responseCode.badRequest:case this.constants.responseCode.internalServerError:case this.constants.responseCode.serviceUnavailable:case this.constants.responseCode.ok:this.scenario.fail({errorCode:r,errorMessage:n});break;default:this.scenario.incomplete({statusCode:r,errorMessage:n,errorCode:e.errorCode})}}else if(this.scenario.mark("scenario-stop-pending"),this.filesSharingHelper.shareLogInfo(this.constants.files.actionLogs.fileOpenError,this.fileId,this.fileErrorCode,this.errorReasonForTelemetry),this.scenario){var a={errorCode:e&&(e.errorCode||e.internalErrorCode),statusCode:e&&e.statusCode};this.sharepointScenarioHandler.getFilesScenario(a,this.constants.files.scenarioActions.getFiles).finishScenario(this.scenario)}},e.prototype.checkForInvalidSPOUrl=function(e){return!!e&&(e===this.constants.events.appState.reasons.resourceDisabled||e.errorMessage===this.constants.events.appState.reasons.resourceDisabled||e.errorCode===this.constants.errorCodes.acquireTokenOtherError)},e.prototype.isNStarViewerType=function(){return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp||this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email},e}();angular.module("teamspace.fileOfficeFrame",["teamspace.loggingService","teamspace.utilityService","teamspace.routeUtilityService","teamspace.filesUtilityService","teamspace.filesActionService","teamspace.filesEntityService","teamspace.filesRedeemService","teamspace.analyticsService","teamspace.platformDetectService","teamspace.authenticationService","teamspace.services.files.modules.sharePoint.sharePointFileDetailsRepository","teamspace.services.files.modules.sharePoint.sharePointFilePreviewService","teamspace.services.files.modules.scenarios.sharepointScenarioHandler","teamspace.services.files.modules.sharePoint.vroom.sharepointShareService","teamspace.navigationService","teamspace.filesDocStageHelperService","teamspace.services.files.modules.sharePoint.filesSharingHelper"]).component("fileOfficeFrame",{bindings:{serviceName:"<",fileType:"<",objectUrl:"<",baseUrl:"<",fileId:"<",threadId:"<?",onTitleBarClosed:"&?",scenarioName:"<",userClickTime:"<",shareUrl:"<",shareId:"<"},template:r,controller:n})},2273:function(e,t){e.exports='<div id="file-office-frame" class="flex-fill">\n\n  \x3c!-- busy animation --\x3e\n  <busy-animation size="medium" ng-if="!($ctrl.fileDetail || ($ctrl.useOneUp && $ctrl.oneUpParams && !$ctrl.wacEdit)) && !$ctrl.fileErrorCode && !$ctrl.useNStarViewerExpInMainWindow" context="file-office-frame">\n  </busy-animation>\n\n  <file-document-title-bar id="ts-file-document-title-bar" ng-show="$ctrl.displayTitleBar || $ctrl.fileErrorCode" is-edit-mode="$ctrl.wacEdit" display-title-bar="$ctrl.displayTitleBar" edit-action="$ctrl.editAction" file-name="::$ctrl.fileName" file-type="::$ctrl.fileType" file-id="::$ctrl.fileId" hide-close="::!$ctrl.onTitleBarClosed" on-close="::$ctrl.onTitleBarClosed()" is-enabled="true" primary-options="::$ctrl.titleBarPrimaryOptions" more-options="::$ctrl.titleBarMoreOptions" move-edit-in-browser-from-more-options="$ctrl.moveEditInBrowserFromMoreOptions" error="$ctrl.fileErrorCode" error-reason-for-telemetry="$ctrl.errorReasonForTelemetry" conversation-info="::$ctrl.titleBarConversationInfo" viewer-type="::$ctrl.viewerType">\n  </file-document-title-bar>\n\n  <file-full-alert class="flex-fill" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" object-url="{{$ctrl.objectUrl}}" share-url="{{$ctrl.shareUrl}}">\n  </file-full-alert>\n\n  <div class="office-frame flex-fill" ng-if="!$ctrl.fileErrorCode">\n    <div tabindex="0" set-focus="true" id="file-office-frame-container" acc-role="tab-handler-document-viewer-frame" role="application" class="flex-fill office-viewer-container" aria-label="{{::$ctrl.getAccessibleIframeNotice()}}" ng-if="::$ctrl.isPreProcessingComplete && !$ctrl.useNStarViewerExpInMainWindow" ng-keydown="$ctrl.openInNewTab($event)">\n      <file-office-viewer ng-if="$ctrl.fileDetail && ($ctrl.wacEdit || !$ctrl.useOneUp)" type="::$ctrl.fileDetail.type" scenario="$ctrl.scenario" wac-url-source="$ctrl.wacUrl" wac-edit="$ctrl.wacEdit" ctx="::$ctrl.ctx" file-type="::$ctrl.fileType" class="flex-fill">\n      </file-office-viewer>\n      <file-one-up-viewer ng-if="$ctrl.oneUpParams && !$ctrl.wacEdit" type="::$ctrl.oneUpParams.fileType" scenario="$ctrl.oneUpParams.scenario" site-url="$ctrl.oneUpParams.baseUrl" server-relative-url="$ctrl.oneUpParams.serverRelativeUrl" file-detail="::$ctrl.oneUpParams.fileDetail" object-url="::$ctrl.objectUrl" service-name="::$ctrl.oneUpParams.serviceName" drive-item="$ctrl.driveItem" file-id="::$ctrl.fileId" class="flex-fill">\n      </file-one-up-viewer>\n    </div>\n\n    <div tabindex="0" set-focus="true" id="file-office-frame-experience-container" class="flex-fill office-viewer-container" role="application" aria-label="{{::$ctrl.getAccessibleIframeNotice()}}" ng-if="$ctrl.useNStarViewerExpInMainWindow" ng-keydown="$ctrl.openInNewTab($event)">\n      <div id="ts-unified-app-loader" ng-if="$ctrl.showSpinner">\n        <busy-animation size="medium" context="file-unified-app-viewer">\n        </busy-animation>\n      </div>\n      \x3c!-- ng-show ensures that files experience is not visible till redeem call succeeds.--\x3e\n      <file-unified-app-viewer ng-show="::$ctrl.isPreProcessingComplete" is-edit-mode="$ctrl.wacEdit" file-type="::$ctrl.fileType" object-url="::$ctrl.objectUrl" user-click-time="::$ctrl.userClickTime" scenario="::$ctrl.scenario" ctx="::$ctrl.ctx" drive-item-call-start-time="::$ctrl.driveItemCallStartTime" class="flex-fill file-unified-app-viewer-container" redeem-promise="$ctrl.redeemPromise" hide-spinner="$ctrl.hideSpinner" display-title-bar="$ctrl.displayTitleBar" more-options="::$ctrl.titleBarMoreOptions" hide-close="::!$ctrl.onTitleBarClosed" on-close="::$ctrl.onTitleBarClosed()" file-name="::$ctrl.fileName" thread-id="::$ctrl.threadId" service-name="::$ctrl.serviceName" move-edit-in-browser-from-more-options="$ctrl.moveEditInBrowserFromMoreOptions" file-id="::$ctrl.fileId">\n      </file-unified-app-viewer>\n    </div>\n  </div>\n</div>'},2274:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2275),r=function(){function e(e,t,i,s,r,n,o,a,l,c){var d=this;this.$scope=e,this.$sce=t,this.$window=i,this.$location=s,this.$timeout=r,this.constants=n,this.utilityService=a,this.filesUtilityService=c,this.initialActiveElement=document.getElementById("file-office-frame-container")||window,this.isOneNote=n.fileExtensions.onenote.indexOf(this.type)>=0,this.isVisio=n.fileExtensions.visio.indexOf(this.type)>=0,this.isElectronApp=l.isElectron(),this.useHwaWebView=l.isHwa()&&o.valueAsBoolean(n.settings.names.enableMsWebViewFileOfficeViewer),this.useElectronWebView=this.isElectronApp;var h=i.electronSafeIpc;this.useHwaWebView?(this.init(),this._stopFullScreenScenario()):h&&this.useElectronWebView?(h.send(n.events.desktopApp.allowWebViewCreate),h.once(n.events.desktopApp.webViewCreationEnabled,function(){d.init(),d._stopFullScreenScenario(),d.isWebViewCreationEnabled=!0})):(this.init(),this._registerScenarioEnd()),this._ensureInitialFocusIsNotStolen()}return e.$inject=["$scope","$sce","$window","$location","$timeout","constants","settingsService","utilityService","desktopUtilityService","filesUtilityService"],e.prototype.$onChanges=function(e){var t=this;if(e.wacUrlSource&&!e.wacUrlSource.isFirstChange()){var i=this.$window.electronSafeIpc;i&&this.useElectronWebView&&this.isWebViewCreationEnabled||this.useHwaWebView?(this.init(),this._stopFullScreenScenario()):i&&this.useElectronWebView||(this.wacUrl=null,this.$timeout(function(){return t.init()},0,!1),this._registerScenarioEnd())}},e.prototype.init=function(){var e=this,t=this.wacUrlSource+"&hh=1",i=t.match(/sc=pmo[^&]*/g);t=t.replace(/sc=.*?&/g,""),this.wacEdit?t+="&sc=OwaEdit":i&&i.length&&(t=t+"&"+i[0]),t+="&uih=Teams";var s=this.filesUtilityService.isNStarViewerExpInMainWindowEnabled(this.fileType);t=this.ctx===this.constants.scenarios.files.newFileCreationContext&&s?t+"&uiEmbed=1":t;var r=this.utilityService.parseUrl(t);if(this.wacOrigin=r&&r.origin,this.wacUrl=this.$sce.trustAsResourceUrl(t),this.sourceElement=document.getElementsByClassName("wopi-iframe")[0],this.sourceElement){var n=this.layout.bind(this);this.sourceElement.addEventListener("dom-ready",n),this.$window.addEventListener("resize",n),this.$scope.$on("$destroy",function(){e.sourceElement.removeEventListener("dom-ready",n),e.$window.removeEventListener("resize",n)})}},e.prototype.layout=function(){if(this.sourceElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.sourceElement.clientWidth,t=this.sourceElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype._registerScenarioEnd=function(){var e=this,t=this.$location.host();if(!(!this.useElectronWebView&&(t.endsWith(this.constants.counters.skype.skypeDomain)||t.endsWith(this.constants.counters.microsoft.domain)))||this.isOneNote||this.isVisio||this.wacEdit)this._stopFullScreenScenario();else{var i=angular.element(this.$window);this._onPostMessageReceive&&(i.unbind("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler()),this._onPostMessageReceive=function(t){return e._postMessageReceiveHandler(t)},i.on("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler=this.$scope.$on("$destroy",function(){i.unbind("message",e._onPostMessageReceive)})}},e.prototype._postMessageReceiveHandler=function(e){var t=e.originalEvent||e;if(t&&t.origin&&t.origin===this.wacOrigin){var i=JSON.parse(t.data||"{}");i.MessageId&&i.MessageId.toLowerCase()==="App_LoadingStatus".toLowerCase()&&(this._stopFullScreenScenario("wac"),angular.element(this.$window).unbind("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler(),this._onPostMessageReceive=null)}},e.prototype._stopFullScreenScenario=function(e){void 0===e&&(e=""),this.scenario&&this.scenario.stop({context:e})},e.prototype._ensureInitialFocusIsNotStolen=function(){var e=this;this.focusCounter=0;var t=angular.element(this.$window);this._onWindowBlur&&(t.unbind(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler()),this._onWindowBlur=function(t){return e._onWindowBlurHandler(t)},t.on(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler=this.$scope.$on("$destroy",function(){t.unbind(e.constants.events.jQuery.blur,e._onWindowBlur)})},e.prototype._onWindowBlurHandler=function(e){var t=this;this.focusCounter++;var i=this.isOneNote?2:1;this.focusCounter==i&&(angular.element(this.$window).unbind(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler(),this._onWindowBlur=null),this.$timeout(function(){return angular.element(t.initialActiveElement).focus()},100,!1)},e}();angular.module("teamspace.fileOfficeViewer",["teamspace.settingsService","teamspace.filesUtilityService"]).component("fileOfficeViewer",{bindings:{type:"<",scenario:"<",wacEdit:"<",wacUrlSource:"<",ctx:"<",fileType:"<"},template:s,controller:r})},2275:function(e,t){e.exports='<div id="file-office-viewer" class="flex-fill">\n\n  <iframe ng-if="$ctrl.wacUrl && !($ctrl.useElectronWebView || $ctrl.useHwaWebView)" ng-src="{{$ctrl.wacUrl}}" ng-attr-sandbox="{{ ::$ctrl.isElectronApp ? \'allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts\' : undefined }}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n  </iframe>\n\n  <webview ng-if="::$ctrl.useElectronWebView && !$ctrl.useHwaWebView" ng-src="{{$ctrl.wacUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true" webpreferences="nativeWindowOpen=yes" allowpopups="">\n  </webview>\n\n  \x3c!-- TODO tac: use embedded-page-container instead once it supports url updates --\x3e\n  <x-ms-webview ng-if="::$ctrl.useHwaWebView" ng-src="{{$ctrl.wacUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n  </x-ms-webview>\n</div>\n'}},[2263]);